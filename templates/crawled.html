<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/static/css/global.css">
    <link rel="stylesheet" type="text/css" href="/static/css/crawled.css">
    <script src="/static/js/cytoscape.min.js"></script>
    <title>Results</title>
</head>
<body>
    <main id="main">
        <div id="cy">
            
        </div>
        <div id="menu">
            <div id="keycodes">
                <div class="item">
                    <div class="key" style="background-color: #212529;"></div>
                    <span>URI</span>
                </div>
                <div class="item">
                    <div class="key" style="background-color: #f5b7b1;"></div>
                    <span>author</span>
                </div>
                <div class="item">
                    <div class="key" style="background-color: #3498db;"></div>
                    <span>cite-as</span>
                </div>
                <div class="item">
                    <div class="key" style="background-color: #27ae60;"></div>
                    <span>describedby</span>
                </div>
                <div class="item">
                    <div class="key" style="background-color: #f1c40f;"></div>
                    <span>type</span>
                </div>
                <div class="item">
                    <div class="key" style="background-color: #e67e22;"></div>
                    <span>license</span>
                </div>
                <div class="item">
                    <div class="key" style="background-color: #c0392b;"></div>
                    <span>item</span>
                </div>
                <div class="item">
                    <div class="key" style="background-color: #935116;"></div>
                    <span>collection</span>
                </div>
                <div class="item">
                    <div class="key" style="background-color: #8e44ad;"></div>
                    <span>linkset</span>
                </div>
                <div class="item">
                    <div class="key" style="background-color: #d4e6f1;"></div>
                    <span>Metadata</span>
                </div>
            </div>
            {# <form action="{{ url_for('store') }}" method="post">
                <input type="hidden" name="graph" value="{{joint_kg['signposts']}}">
                <input type="hidden" name="provenance" value="{{joint_kg['provenances'][0]}}">
                <button type="submit">Store Graph</button>
            </form> #}
            <button id="back"><a href="{{ url_for('index') }}">Back</a></button>
            
        </div>
    </main>
    
     <script>



        let signposts = []
        {# let origin = '{{ graphs[0].provenance }}'
        {% for graph in graphs%}
            signposts.push(
                {
                    data: { id: '{{graph.provenance}}' },
                    style: {
                        'width': 75,
                        'height': 75
                    }
                }
            )
            {% for s, p, o in graph.signposts %}
                predicate = '{{p}}'
                predicate = predicate.split('/').pop();
                signposts.push(
                    {group: 'nodes', data: {id: '{{o}}', label: predicate} },
                    {group: 'edges', data: {source: '{{s}}', target: '{{o}}'} }//id: count, label: predicate
                )
            {% endfor %}
            {% for link in graph.linksets %}
                linkset = '{{link}}'
                console.log(linkset)
                {% for s, p, o in graphs[0].linksets[link].signposts %}
                    predicate = '{{p}}'
                    predicate = predicate.split('/').pop();
                    signposts.push(
                        {group: 'nodes', data: {id: '{{o}}', label: predicate} },
                        {group: 'edges', data: {source: linkset, target: '{{o}}'} }//id: count, label: predicate
                    )
                {% endfor %}
            {% endfor %}
        {% endfor %} #}


        // JOINT KG ////////////////////////
        {# {% for provenance in joint_kg['provenances'] %}
            signposts.push(
                {
                    data: { id: '{{provenance}}' },
                    style: {
                        'width': 75,
                        'height': 75
                    }
                }
            )
        {% endfor %} #}
        {% for s, p, o in joint_kg['signposts'] %}
            predicate = '{{p}}'
            predicate = predicate.split('/').pop();
            signposts.push(
                {group: 'nodes', data: {id: '{{o}}', label: predicate} },
                {group: 'edges', data: {source: '{{s}}', target: '{{o}}', label: predicate} }//label: predicate
            )
        {% endfor %}
        ///// METADATA GRAPH DEMO//////
        {% if displaymetadata %}
            {% for s, p, o in joint_kg['metadata'] %}
                predicate = '{{p}}'
                signposts.push(
                    {group: 'nodes', data: {id: '{{o}}', label: predicate}, classes:'metadata' },
                    {group: 'edges', data: {source: '{{s}}', target: '{{o}}', label: predicate} }//label: predicate
                )
            {% endfor %}
        {%endif%}
        ////////////////////////////////////

        console.log(signposts)
        
        var cy = cytoscape({
            container: document.getElementById('cy'),

            elements: {
                nodes: [
                {
                    data: { id: '{{joint_kg['provenances'][0]}}' },
                    style: {
                        'width': 150,
                        'height': 150
                    }
                }
                ]
            },

            // so we can see the ids
            style: [
                {
                selector: 'node',
                style: {
                    'label': 'data(id)', // Use node's 'label' property
                    //'text-valign': 'center', // Center vertically
                    //'text-halign': 'center', // Center horizontall
                    //'text-wrap': 'wrap',
                    //'text-max-width': '80px',
                    'background-color': '#2c3e50',
                    'width': 100,
                    'height': 100,
                    'color': '#212529'
                }
                },
                {
                selector: 'edge',
                style: {
                    {% if labels %}
                    'label': 'data(label)',
                    {% endif %}
                    //'text-margin-y': -20,
                    'target-arrow-shape': 'triangle', // Arrow at target node
                    'target-arrow-color': 'black',    // Match edge color
                    'curve-style': 'bezier'
                }
                }
            ]
        });
        cy.add(signposts)

        

        var layout = cy.elements().layout({
            name: 'concentric', // circle
            minNodeSpacing: 50
          });
          
        layout.run();
        {% if edgecolor %}
        cy.edges().forEach(edge => {
            colour = colourCode(edge.data('label'))
            edge.style('line-color', colour);
        });
        {% else %}
        cy.nodes().forEach(node => {
            colour = colourCode(node.data('label'))
            if (node.hasClass('metadata')) {
                colour = '#d4e6f1'
            }
            node.style('background-color', colour);
        });
        {% endif %}

        {# cy.style()
        .selector('.metadata')
        .style({
            'background-color': '#a9cce3'
        })
        .update(); #}

        {# function showLinksetSignposts(node) 
        {
            s = []
            {% for graph in graphs %}
                {% for linkset in graph.linksets%}
                    if ('{{linkset}}' == node.data('id')) 
                    {
                        {% for s, p, o in graph.linksets[linkset].signposts %}
                            predicate = '{{p}}'
                            predicate = predicate.split('/').pop();
                            s.push(
                                {group: 'nodes', data: {id: '{{o}}', label: predicate} },
                                {group: 'edges', data: {source: node.data('id'), target: '{{o}}'} }
                            )
                        {% endfor %}
                    }
                {% endfor %}
            {% endfor %}
            // method 1 - reposition whole layout
            cy.add(s)
            cy.layout({
                name: 'concentric',
                animate: true,
                minNodeSpacing: 50
            }).run();

            cy.nodes().forEach(node => {
                colour = colourCode(node.data('label'))
                node.style('background-color', colour);
            });
        }

        function hideLinksetSignposts(node) 
        {
            let edgesToRemove = cy.edges(`[source = "${node.data('id')}"]`); // Select all outgoing edges
            let targetNodes = edgesToRemove.targets().filter(tnode => tnode.id() !== node.data('id')); // Exclude source node itself
            edgesToRemove.remove(); // Remove the selected edges
            targetNodes.remove();
        }



        cy.on('tap', 'node[label = "linkset"]', function(evt) {
            let node = evt.target;
            if (node.hasClass('show')) {
                hideLinksetSignposts(node);
            } else {
                showLinksetSignposts(node);
            }
            node.toggleClass('show')
        }); #}

        function colourCode(predicate) 
        {
            switch (predicate)
            {
                case "citeas":
                    return "#3498db";
                    break;
                case "item":
                    return "#c0392b";
                    break;
                case "describedby":
                    return "#27ae60";
                    break;
                case "license":
                    return "#e67e22";
                    break;
                case "type":
                    return "#f1c40f";
                    break;
                case "linkset":
                    return "#8e44ad";
                    break;
                case "author":
                    return "#f5b7b1";
                    break;
                case "collection":
                    return "#935116";
                    break;
                default:
                    return "#2c3e50"
            }
        }
     </script>
</body>
</html>